# Ksy Parser 実装仕様書

## 概要

Kaitai Struct (.ksy) 形式のバイナリレイアウト定義ファイルを読み込み、
動的にバイナリデータをパースする機能を実装する。

外部ライブラリへの依存は0とし、すべて自前で実装する。

## 決定事項

### 1. YAMLパース
- **方針**: 簡易YAMLパーサーを自作
- **理由**: ksyで使う機能（インデント、リスト、マッピング）に限定し、完全なYAML仕様は不要

### 2. エンディアン
- **方針**: Kaitai Struct準拠
  - `meta.endian` でデフォルト指定（`le` / `be`）
  - 未指定の場合は、フィールドごとに `u4le`, `u4be` のように型名で明示必須
  - `meta.endian` が指定されていれば `u4` だけでOK

### 3. 対応する基本型
- **整数型**:
  - `u1`, `u2`, `u3`, `u4` (符号なし) + le/be指定
  - `s1`, `s2`, `s3`, `s4` (符号あり) + le/be指定
  - ※ `u3`, `s3` (3バイト/24ビット) は独自拡張
- **文字列型**:
  - `str` (サイズ指定文字列)
  - `strz` (ヌル終端文字列)

### 4. 文字列エンコーディング
- **デフォルト**: UTF-8
- `meta.encoding` または フィールドの `encoding` で上書き可能

### 5. 式（Expression）評価
- **方針**: フィールド参照のみ
- `size: file_name_len` は可能
- `size: file_name_len + 4` のような計算式は非対応（将来拡張）

### 6. 繰り返し（repeat）
- **対応**: `repeat: expr` + `repeat-expr: N` のみ
- N回の繰り返しに対応
- `repeat: eos`, `repeat: until` は非対応（将来拡張）

### 7. 条件分岐（if）
- **対応しない**（将来拡張）

### 8. ユーザー定義型（types）
- **対応する**
- `types` セクションで型定義
- ネストした構造を表現可能

### 9. 列挙型（enums）
- **対応しない**（将来拡張）

---

## アーキテクチャ

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│   .ksy ファイル  │────▶│  YamlParser      │────▶│  KsySchema      │
│   (YAML文字列)   │     │  (YAML→オブジェクト) │     │  (型定義)        │
└─────────────────┘     └──────────────────┘     └────────┬────────┘
                                                          │
                                                          ▼
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│   バイナリデータ  │────▶│ DynamicParser    │────▶│  BinaryRange    │
│   (Uint8Array)   │     │ (スキーマに従って │     │  (既存の構造)    │
└─────────────────┘     │  動的にパース)    │     └─────────────────┘
                        └──────────────────┘
```

## ファイル構成

```
src/
├── ksy/
│   ├── YamlParser.ts     # 簡易YAMLパーサー
│   ├── KsySchema.ts      # スキーマの型定義
│   ├── DynamicParser.ts  # スキーマに基づく動的パーサー
│   └── primitives.ts     # 基本型の読み取り関数
├── definitions/
│   └── zip.ksy           # ZIP定義ファイル（テスト用）
```

## 実装優先順位

1. [x] 決定事項のドキュメント作成
2. [ ] KsySchema 型定義
3. [ ] 簡易YAMLパーサー
4. [ ] 基本型の読み取り関数
5. [ ] DynamicParser（seq処理）
6. [ ] ユーザー定義型（types）
7. [ ] 文字列型（str, strz）
8. [ ] 繰り返し（repeat: expr）

## 将来の拡張予定

- [ ] 条件分岐（if）
- [ ] 列挙型（enums）
- [ ] 式の計算（算術演算）
- [ ] `repeat: eos`, `repeat: until`
- [ ] 8バイト整数（u8, s8）
- [ ] 浮動小数点（f4, f8）
- [ ] switch-on（型の動的選択）
- [ ] instances（計算フィールド）
